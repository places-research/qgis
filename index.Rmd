---
title: "Análise Espacial"
author:
  - name: Renata Lúcia Magalhães de Oliveira
    url: https://places-research.github.io/rspatial
    affiliation: CEFET-MG
    affiliation_url: https://www.cefetmg.br
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: spacelab
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 2
    number_sections: false
    code_folding: hide
    code_download: true
bibliography: references.bib
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Competências a serem desenvolvidas
Ao final desse mini-curso, os alunos deverão ser capazes de discutir os seguintes conceitos:  

- Pensamento espacial     
- Introdução à cartografia   
  - forma e dimensões terrestres   
  - representações: sistemas geodésicos, modelos e datum    
  - sistemas de coordenadas geográficas e projetadas   
- Sistemas de Informações Geográficas (_Geographic Information Systems_)   
- Unidades espaciais e representação de fenômenos espaciais   
- Distâncias   
- QGIS   
  - Ambiente e funcionalidades básicas do QGIS   
  - Complementos: instalação e para que servem  
  - Mudança de datum e sistemas de coordenadas   
  - Tabela de atributos   
  - Estruturas de dados espaciais  
    - classificação: vetoriais e matriciais   
    - interoperabilidade   
    - geocodificação   
  - Funções básicas em GIS   
      - seleção por atributo e por localização    
      - join por código e join espacial   
      - mapas temáticos   
      - geração de centroides e agregação de variaveis  
      - conceito de redes   
      - layout de impressão   

# Palavras-chave



# Pensamento espacial

>” todas as coisas são parecidas mas coisas mais próximas se parecem mais que coisas mais distantes”. Waldo Tobler

- Encontrar significado em formas, tamanho, orientação, localização, direção ou trajetória de objetos, processos e fenômenos

- Encontrar significado na localização relativa de múltiplos objetos, processos e fenômenos.

  - O que diferencia dados espaciais e não espaciais?    
  - O que existe em uma determinada localização?   
  - Onde posso encontrar um determinado objeto?   
  - O que mudou ao longo do tempo?   
  - Qual o melhor caminho?   
  - Como os objetos são distribuídos no espaço?   
  - Como as condições serão alteradas no futuro? 

# Representações: sistemas geodésicos, modelos e datum    

### Geóide   
Forma irregular, com ondulações e depressões

```{r echo=FALSE, out.width='50%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/gravidade_terra.png')
```
   
     
É preciso buscar um modelo mais simples para representar a Terra.

Geóide
Superfície delimitada pelo nível médio dos mares supostamente prolongado por sob os continentes

Elipsóide
Modelo matemático que define a superfície da Terra.


```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/geoide.png')
```

### Elipsóide de revolução    
Ao girar em torno de seu eixo menor, uma ELIPSE forma um volume achatado nos pólos    

É a figura matemática que mais se aproxima da forma do geóide. Parâmetros são simples 

Parâmetros
a = semi-eixo maior; b = semi-eixo menor; f = achatamento = (a-b)/a

Em geral, cada país ou grupo de países adotou um elipsóide de referência para os trabalhos geodésicos e topográficos que mais se aproxima do geóide na região considerada.


```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/elipsoi_1.png')
```

```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/elipsoide_2.png')
```

## Sistemas geodésicos
Permitem estabelecer uma relação entre um ponto determinado do terreno e um elipsóide de referência.       
Elegem um elipsóide de revolução que melhor se ajuste às características locais do geóide.    

A posição deste elipsóide em relação à Terra, bem como sua forma e tamanho, constituem um conjunto de parâmetros que usualmente são denominados Datum Geodésico.    

### Datum
Marco geodésico, horizontal ou vertical, usado como ponto de origem do sistema geodésico (referência)   

- Datum Vertical ou Altimétrico: referência para altitude (marco “zero” – 0 m)   
```{r echo=FALSE, out.width='50%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/datum.png')
```

- Datum Horizontal ou Planimétrico: referência para coordenadas planimétricas   
```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/geoide_geocentrico.png')
```

```{r echo=FALSE, out.width='30%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/geoide_topocentrico.png')
```

SIRGAS 2000 - Sistema de Referência Geocêntrico para as Américas   
Datum Global, Geocêntrico   

SAD-69 - Sistema Geodésico Sul-Americano 1969     
Datum Local, Topocêntrico   


## Sistemas de referências   
Como estabelecer localizações na Superfície Terrestre?   

- Adotar um modelo matemático da Terra: Datum Geodésico (SAD-69, SIRGAS 2000…)   

- Adotar um sistema capaz de localizar qualquer lugar da Terra: Sistema de Coordenadas   


### Sistemas de coordenadas geográficas
Sistemas de coordenadas geográficas são necessários para a expressão da posição de pontos sobre uma superfície.   

Considerando que esta superfície seja curvilínea (elipsóide ou esfera), cada ponto da superfície terrestre é localizado na interseção de um meridiano e paralelo e seu posicionamento é dado por meio de **valores angulares** que correspondem a sua **latitude** e **longitude**.    

**Meridianos**   
- Num modelo esférico, os meridianos são semi-círculos gerados a partir da interseção de planos verticais que contém o eixo de rotação terrestre com a superfície da Terra. 

- Um semicírculo define um meridiano que com seu antimeridiano formam um círculo máximo.  

- O meridiano de origem, é denominado Meridiano de Greenwich, com o seu antimeridiano, divide a Terra em dois hemisférios: leste e oeste.  

- A leste deste meridiano, os valores da coordenadas são crescentes, variando entre 0° e +180°.   

- A oeste, as medidas são decrescentes, variando entre 0° e -180°.  

**Paralelos**   
- Paralelos são círculos cujo plano é perpendicular ao eixo dos pólos. 

- O Equador é o paralelo que divide a Terra em dois hemisférios (Norte e Sul) e é considerado o paralelo de origem (0°).   

- Partindo-se do Equador em direção aos pólos tem-se vários planos paralelos ao Equador, cujos tamanhos vão diminuindo até que se reduzam a pontos nos pólos Norte (+90°) e Sul (-90°).     

**Latitude e Longitude**    
- Longitude (letra grega lambda λ): É a distância angular entre o lugar e o meridiano de origem, contada sobre um plano paralelo ao Equador.   
- Latitude (letra grega phi ϕ): É a distância angular entre o lugar e o plano do Equador, contada sobre o plano do meridiano que passa no lugar. 

### Sistemas de coordenadas projetadas - projeções cartográficas
Para confeccionar um mapa, precisamos de um método segundo o qual a cada ponto da superfície terrestre corresponda um ponto do mapa e vice versa: **sistema de projeções**.   

A projeção cartográfica **transforma** uma posição sobre a superfície terrestre, identificada por latitude e longitude em uma posição em coordenadas cartesianas/planas (x,y).

Sistemas de coordenadas planas devem ser utilizados para representação de pequenas porções da superfície terrestre (mapas de grande escala). Coordenadas planas não são utilizadas para mapas de pequenas escalas pelo seu potencial de distorção.

Representar uma superfície curva (a Terra) em um plano sempre envolve deformações. **Não existe projeção ideal**. 

As projeções podem ser:   
- Projeção conforme (conformidade): Mantêm ângulos (forma), mas não os tamanhos
- Projeção equidistante: Mantêm distância, mas deforma áreas e ângulos
- Projeção equivalente: Mantêm áreas, mas distorce as formas
- Projeções afiláticas: Não conserva nenhuma das propriedades. Busca reduzir distorções de maneira geral.

**Classificação das projeções geográficas**  
Quanto à Superfície de Projeção:   
- Plana ou Azimutal   
- Cilíndrica   
- Cônica   
- Polissuperficiais (poliédrica, policilíndrica, policônica)   

Quanto ao Tipo de Contato: 
- Tangente 
- Secante

#### UTM - 
O Sistema de projeção Universal Transversa de Mercato apresenta uma superfície de Projeção com 60 cilindros transversos, cada um com uma amplitude de 6 graus em longitude = 60 fusos.    

Cada fuso possui um meridiano central, com 3 graus para cada lado. Os 60 fusos são enumerados a partir do anti-meridiano de Greenwich.   

A unidade é o **metro** tendo como origem o Equador e o Meridiano Central. No hemisfério Sul, o sistema possui o valor 10.000.000,00 m no Equador para a corrdenada Norte, decrescendo para o Sul. E o valor 500.000,00 m no Meridiano Central para a coordenada leste, decrescendo para Oeste e crescendo para leste.     

As Coordenadas UTM definem posições bi-dimensionais e horizontais.

- Fusos UTM no território brasileiro: Fusos 18 a 25

- Belo Horizonte: Fuso 23

# Sistemas de Informações Geográficas
os GIS são um conjunto de ferramentas usadas para coleta e tratamento de informações espaciais, geração de saídas na forma de mapas, relatórios, arquivos digitais, etcc.

- Deve prover recursos para sua armazenagem, gerenciamento, manipulação e análise.  

- Geoprocessamento representa qualquer tipo de processamento de dados georeferenciados (conceito muito mais abrangente). 

- Um SIG é capaz de processar dados gráficos e não gráficos (alfanuméricos), com ferramentas de análises espaciais e modelagens de superfícies.

### Definições de GIS    
“Conjunto poderoso de ferramentas para coletar, armazenar, recuperar, transformar e visualizar dados sobre o mundo real”(Burrough)   

“Um sistema de suporte à decisão que integra dados referenciados espacialmente num ambiente de respostas a problemas” (Cowen)   

“Um banco de dados indexados espacialmente, sobre o qual opera um conjunto de procedimentos para responder a consultas sobre entidades espaciais” (Smith)  

### Por que fazer cartografia digital?
Fazer mapas mais rapidamente.
Fazer mapas mais baratos.
Fazer mapas para usos específicos.
Fazer mapas em situações em que não há disponibilidade de pessoal especializado
Permitir experimentos com representações espaciais diversas dos mesmos dados.
Facilitar atualização de mapas.
Facilitar análises de dados que exigem interação entre estatística e mapas.
Minimizar a necessidade de mapas em papel.
Fazer mapas que não podem ser representados em papel, como em 3D, por exemplo.

### Geocodificação
A geocodificação é um processo que permite transformar dados de localização como coordenadas, endereços e nomes de estabelecimentos em uma geolocalização com latitude e longitude.

# Unidades espaciais e representação de fenômenos espaciais
A escolha das unidades espaciais dependende tanto de 



# Dados espaciais
Dados espaciais podem apresentar diferentes formatos e comporem diferentes estruturas. Por agora, utilizaremos apenas o formato criado pela ESRI denominado `shapefile`. 

## Estrutura do shapefile
.dbf – Banco de dados – Informações dos atributos das feições
.prj – Sistemas de coordenadas geográficas
.snb e .sbx – Armazenam os índices espaciais das feições
.shp – Armazenam a geometria das feições
.shx – Armazena o índice da geometria das feições – busca rápida
xml: metadadoem formato XML


Assim como usamos um processador de texto para escrever documentos e lidar com palavras em um computador, podemos usar um aplicativo GIS para lidar com informações espaciais em um computador. GIS significa "Sistema de Informação Geográfica".

Um GIS consiste em:
- Dados digitais -- as informações geográficas que você visualizará e analisará usando hardware e software de computador.
- Hardware de computador -- computadores usados para armazenar dados, exibir gráficos e processar dados.
- Software de computador -- programas de computador que rodam no hardware do computador e permitem que você trabalhe com dados digitais. Um programa de software que faz parte do GIS é chamado de Aplicativo GIS.
Com uma aplicação GIS você pode abrir mapas digitais em seu computador, criar novas informações espaciais para adicionar a um mapa, criar mapas impressos personalizados de acordo com suas necessidades e realizar análises espaciais.
Vejamos um pequeno exemplo de como o GIS pode ser útil. Imagine que você é um profissional de saúde e anote a data e o local de residência de cada paciente que você trata.


# Distâncias
Um dos tópicos mais importantes no momento de se realizar uma análise de agrupamento sobre a base de dados é em relação à medida de distância adotada.

Diversos fatores são levados em consideração quando se faz uma análise como inferência estatística, métricas adotadas para composição do modelo, quantidade de dados a serem minerados; o que exige conhecimento por parte do analista de qual medida de distância escolher de acordo com o domínio do problema e o conjunto de dados, ou se não houver escolha ao menos ter consciência do tipo de resultado que  pode ser obtido de acordo com a medida de distância implantada.

A Distância Euclidiana é definida como a soma da raiz quadrada da diferença entre x e y em suas respectivas dimensões.

Já a Distância Manhattan tem uma definição mais simples na qual é apenas a soma das diferenças entre x e y em cada dimensão.

Abaixo segue a representação matemática dessas duas medidas:

Distância Euclideana: √((x1 – x2)² + (y1 – y2)²).

Distância Manhattan: |x1 – x2| + |y1 – y2|.

A Distância Euclidiana seria o segmento de uma reta na qual indicaria uma possível rota de helicóptero (na qual não haveria preocupação com as ruas já que é um veículo aéreo, e geometricamente seria a hipotenusa de um triângulo) e a Distância Manhattan seria um segmento de retas na vertical quanto na horizontal semelhante a uma rota de carro (já que esse obedece o sentido das ruas, e devido à esse comportamento essa medida de distância é também conhecida como City Block, e  geometricamente seriam a soma dos catetos).
,
As medidas de distância de uma maneira geral podem ser definidas como medidas de similaridade, e dissimilaridade; na qual a primeira é para definir o grau de semelhança entre as instâncias e realizam o agrupamento de acordo com a sua coesão, e a segunda de acordo com as diferenças dos atributos das instâncias. Como forma de reduzir o escopo de assuntos tratados, esse post irá adotar abordar somente as distâncias de similaridade mais comuns que são a Distância Euclidiana e a Distância Manhattan.


# QGIS
## Ambiente e funcionalidades básicas do QGIS   
**1. Ambiente geral**   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q1.png')
```

**2. Complementos**

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q2.png')
```

**3. Acesso aos dados espaciais**   

Vamos trabalhar com dados na estrutura `shapefile` - camadas vetoriais   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q3.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q4.png')
```

**4. Mudança de atributos dos shapefiles**

Mudança de cores das camadas    

- acesso às propriedades da camada   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q7.png')
```

- Recursos para alteração da representação das feições nas camadas    

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q5.png')
```

> Pode haver incompatibilidade entre feições causadas pela qualidade do dado vetorial ou por uso de diferentes projeções. Isso não inviabiliza o uso do dado espacial, mas podem ser necessárias conversões de sistemas de referência ou mesmo tratamento da geometria das feições.   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q8.png')
```


**5. Mudança de datum e sistemas de coordenadas**   

**Transformações on-the-fly**   

O mecanismo de transformações `on-the-fly` realiza reprojeções automáticas para fins de visualização/renderização.

São reprojeções dinâmicas, que não afetam o dado original   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q9.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q10.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q11.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q12.png')
```

**Reprojetar ou converter**   
Para reprojetar ou converter para outro formato: 
Salvar a camada com o novo sistema de referência/formato
Botão direito sobre a camada > Save as... 

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q13.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q14.png')
```

**6. Tabela de atributos**    

A `tabela de atributos` pode ser acessada pelo mesmo menu da camada. Na `tabela de atributos` são apresentadas as observações e os atributos de cada feição geométrica gerreferenciada. É análoga a uma planilha ou a um data.frame (`R`). É importante lembrar que só é possível associar um banco de dados (tabela de atributos) a um dado vetorial. Cada observação é uma feição geométrica desse dado.    

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q17.png')
```


```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q18.png')
```



**7. Geocodificação**   

O complemento que utilizo para geocodificação é o `MMQGIS`, que conecta direto com as APIs do Google e do OSM. Para fazer a geocodificação pelo Google, é necessária chave de acesso e token, pois acima de 2.500 requisiçoes por IP por dia são cobradas. Assim, recomendo a utilização do `OSM`. 

O arquivo a ser organizado e importado no `QGIS` para geocodificação é no formato `.csv` e codificação `UTF-8`. Nesse arquivo devem ser organizadas as informações sobre o endereço em quatro colunas:   
- address   
- city   
- state   
- country   

Na primeira coluna colocamos o endereço completo sem as informações de cidade, estado e país.   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q16.png')
```

<iframe width="560" height="315" src="https://www.youtube.com/embed/qvUgWpidJ5A" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ZIeLmrR7Kz8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<iframe width="560" height="315" src="https://www.youtube.com/embed/d9UAn8M9tZ8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

**8. Mapas temáticos** 

Mapas temáticos são representações em feições geométricas do atributo de interesse utilizando elementos visuais para visualização da estrutura espacial desses dados. 

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q22.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q23.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q24.png')
```

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q25.png')
```


```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q26.png')
```

**9. Geração de Layout de impressão**   
Para gerarmos o layout de impressão dos mapas, é necessário acessar o ambiente de edição do layout.   

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q19.png')
```

O ambiente de edição de layout tem a seguinte estrutura:


```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q20.png')
```

Para inserir os elementos gráficos e textuais no layout, você deve acessar o menu à esquerda da página em branco e incluir mapas, legendas, indicador de norte, escala, dentre outros elementos. 

```{r echo=FALSE, out.width='60%'}
knitr::include_graphics('D:/Google Drive/01_courses/urban_analytics/images/q21.png')
```



**10. Manipulação de dados**
1. seleção por atributo e por localização
2. join por código e join espacial
3. geração de centroides e agregação de variaveis




# **Mão na massa - QGIS**   
## Dados espaciais e sistemas de referência
1. Abrir o `shapefile` e verificar qual o sistema de coordenadas ativo.    
2. Transformar o sistema de coordenadas em `WGS84` e salvar como um novo shapefile   
3. Transformar o sistemas de coordenadas geográficas para coordenadas projetadas `SIRGAS 2000 - UTM 23 S`
4. Mudar a cor dos dados vetoriais para '

## Tabela de atributos e manipulação de dados espaciais   
1. Verificar o número de observações e o número de atributos na `tabela de atributos`   
2. Selecionar setores censitários com população menor do que 400 habitantes.    
3. Exportar apenas os dados selecionados como um novo shapefile.   
4. Abrir os dados referentes à renda em cada setor censitário e importar os dados para o shapefile original.
5. Abrir os dados de empresas no município de Belo Horizonte. 
6. Selecionar os pontos que estão localizados em setores censitários com mais de 500 habitantes. 
7. Contar o número de pontos em cada unidade espacial
8. Agregar dados de população dos setores censitários em bairros
9. Agregar dados de população de bairros para regionais8. Elaborar mapas temáticos de renda, população, áreas de preservação
10. Gerar centroides dos setores censitários

## Mapas temáticos
1. Elaborar mapas temáticos 


## Layout de impressão
1. Gerar layout de impressão contendo legenda, indicação de norte, escala.

